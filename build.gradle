buildscript {
    ext {
        spock_version = "1.1-groovy-2.4-rc-2"
    }
}
plugins {
    id "java-gradle-plugin"
    id "groovy"
    id "maven-publish"
    id "com.gradle.plugin-publish" version "0.9.10"
}

group "net.hallatech"
version "0.1"

if (!hasProperty('release') || (hasProperty('release') && release!='true')) {
    project.version+='-SNAPSHOT'
}

sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    //Groovy test source with Spock excluding groovy core
    testCompile("org.spockframework:spock-core:${spock_version}") {
        exclude module: "groovy-all"
    }
}

//Configure functional tests
sourceSets {
    functionalTest {
        groovy.srcDir file("src/functionalTest/groovy")
        resources.srcDir file("src/functionalTest/resources")
        compileClasspath += sourceSets.main.output + configurations.testRuntime
        runtimeClasspath += output + compileClasspath
    }
}

task functionalTest(type: Test) {
    description = "Runs the functional tests."
    group = "verification"
    testClassesDirs = sourceSets.functionalTest.output.classesDirs
    classpath = sourceSets.functionalTest.runtimeClasspath
    mustRunAfter test
}

check.dependsOn functionalTest

gradlePlugin {
    testSourceSets sourceSets.functionalTest
}

dependencies {
    //Groovy
    functionalTestCompile("org.spockframework:spock-core:${spock_version}") {
        exclude module: "groovy-all"
    }
}

//Configure the auto-generated plugin manifest
gradlePlugin {
    plugins {
        runAssembler {
            id = "net.hallatech.atg-runassembler"
            implementationClass = "net.hallatech.gradle.plugins.RunAssemblerPlugin"
        }
    }
}

//Configure plugin publishing to the Gradle Plugin portal
pluginBundle {
    website = "https://github.com/hallatech/gradle-atg-runassembler"
    vcsUrl = "https://github.com/hallatech/gradle-atg-runassembler.git"
    plugins {
        runAssemblerPlugin {
            id = "net.hallatech.atg-runassembler"
            displayName = "ATG runAssembler Wrapper Plugin"
            description = "Gradle wrapper plugin for the Oracle Commerce ATG runAssembler utility for assembling ATG EARs"
            tags = ["atg","oracle commerce","runAssembler"]
        }
    }
}

//Default build task configuration
defaultTasks "publishtoMavenLocal"