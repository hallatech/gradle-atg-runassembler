buildscript {
    ext {
        spock_version = "1.1-groovy-2.4-rc-2"
    }
}
plugins {
    id "java-gradle-plugin"
    id "groovy"
    id "maven-publish"
}

group "net.hallatech"
version "1.0-SNAPSHOT"

sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    //Groovy test source with Spock excluding groovy core
    testCompile("org.spockframework:spock-core:${spock_version}") {
        exclude module: "groovy-all"
    }
}

//Configure functional tests
sourceSets {
    functionalTest {
        groovy.srcDir file("src/functionalTest/groovy")
        resources.srcDir file("src/functionalTest/resources")
        compileClasspath += sourceSets.main.output + configurations.testRuntime
        runtimeClasspath += output + compileClasspath
    }
}

task functionalTest(type: Test) {
    description = "Runs the functional tests."
    group = "verification"
    testClassesDirs = sourceSets.functionalTest.output.classesDirs
    classpath = sourceSets.functionalTest.runtimeClasspath
    mustRunAfter test
}

check.dependsOn functionalTest

gradlePlugin {
    testSourceSets sourceSets.functionalTest
}

dependencies {
    //Groovy
    functionalTestCompile("org.spockframework:spock-core:${spock_version}") {
        exclude module: "groovy-all"
    }
}

//Configure the auto-generated plugin manifest
gradlePlugin {
    plugins {
        runAssembler {
            id = "net.hallatech.atg-runassembler"
            implementationClass = "net.hallatech.gradle.plugins.RunAssemblerPlugin"
        }
    }
}

defaultTasks "publishtoMavenLocal"